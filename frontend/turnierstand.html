<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Turnierstand - WIZARD Turnier</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <!-- Navigation -->
    <nav class="navbar navbar-dark bg-primary">
      <div class="container-fluid">
        <a class="navbar-brand" href="index.html">
          <i class="bi-arrow-left"></i> Zurück
        </a>
        <span class="navbar-brand mb-0 h1">
          <i class="bi-trophy-fill"></i> Turnierstand
        </span>
        <button class="btn btn-light btn-sm" onclick="refreshStandings()">
          <i class="bi-arrow-clockwise"></i> Aktualisieren
        </button>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4">
      <h1 id="title" class="text-center mb-4">WIZARD Turnierstand</h1>

      <!-- Tournament Ranking -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card shadow">
            <div class="card-header bg-primary text-white">
              <h4 class="mb-0"><i class="bi-bar-chart-fill"></i> Gesamtwertung</h4>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-hover mb-0" id="standingsTable">
                  <thead class="table-light">
                    <tr>
                      <th class="text-center" style="width: 80px;">Rang</th>
                      <th>Spieler</th>
                      <th class="text-end">Turnierpunkte</th>
                      <th class="text-end">Partiepunkte</th>
                      <th class="text-center">Partien</th>
                    </tr>
                  </thead>
                  <tbody id="standingsBody">
                    <tr>
                      <td colspan="5" class="text-center text-muted py-5">
                        <i class="bi-inbox" style="font-size: 3rem;"></i>
                        <p class="mt-3">Noch keine abgeschlossenen Partien</p>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Completed Games List -->
      <div class="row">
        <div class="col-12">
          <div class="card shadow">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
              <h4 class="mb-0"><i class="bi-list-task"></i> Abgeschlossene Partien</h4>
              <span class="badge bg-light text-dark" id="partieCount">0 Partien</span>
            </div>
            <div class="card-body" id="partiesContainer">
              <div class="text-center text-muted py-5">
                <i class="bi-inbox" style="font-size: 3rem;"></i>
                <p class="mt-3">Noch keine abgeschlossenen Partien</p>
                <a href="partie_erstellen.html" class="btn btn-primary mt-2">
                  <i class="bi-plus-circle"></i> Erste Partie erstellen
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Statistics -->
      <div class="row mt-4 mb-4">
        <div class="col-md-4">
          <div class="card shadow text-center">
            <div class="card-body">
              <i class="bi-people-fill text-primary" style="font-size: 2rem;"></i>
              <h5 class="mt-2">Aktive Spieler</h5>
              <h2 id="activePlayers" class="text-primary">0</h2>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card shadow text-center">
            <div class="card-body">
              <i class="bi-grid-3x3 text-success" style="font-size: 2rem;"></i>
              <h5 class="mt-2">Aktive Tische</h5>
              <h2 id="activeTables" class="text-success">0</h2>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card shadow text-center">
            <div class="card-body">
              <i class="bi-check-circle-fill text-warning" style="font-size: 2rem;"></i>
              <h5 class="mt-2">Gespielte Partien</h5>
              <h2 id="totalGames" class="text-warning">0</h2>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
      // Load tournament data from localStorage
      function loadTournamentData() {
        const data = localStorage.getItem('tournamentData')
        return data ? JSON.parse(data) : { parties: [], standings: {} }
      }

      function saveTournamentData(data) {
        localStorage.setItem('tournamentData', JSON.stringify(data))
      }

      // Calculate tournament standings
      function calculateStandings(tournamentData) {
        const standings = {}

        tournamentData.parties.forEach(partie => {
          partie.results.forEach(result => {
            const player = result.spieler
            if (!standings[player]) {
              standings[player] = {
                spieler: player,
                turnierpunkte: 0,
                partiepunkte: 0,
                partien: 0
              }
            }
            standings[player].turnierpunkte += result.turnierpunkte
            standings[player].partiepunkte += result.partiepunkte
            standings[player].partien += 1
          })
        })

        // Convert to array and sort
        const standingsArray = Object.values(standings)
        standingsArray.sort((a, b) => {
          if (b.turnierpunkte !== a.turnierpunkte) {
            return b.turnierpunkte - a.turnierpunkte
          }
          return b.partiepunkte - a.partiepunkte
        })

        return standingsArray
      }

      // Display standings table
      function displayStandings() {
        const tournamentData = loadTournamentData()
        const standings = calculateStandings(tournamentData)
        const tbody = document.getElementById('standingsBody')

        if (standings.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="5" class="text-center text-muted py-5">
                <i class="bi-inbox" style="font-size: 3rem;"></i>
                <p class="mt-3">Noch keine abgeschlossenen Partien</p>
              </td>
            </tr>
          `
          return
        }

        tbody.innerHTML = standings.map((player, index) => {
          const rankBadge = index < 3 ? 
            `<span class="badge bg-${index === 0 ? 'warning' : index === 1 ? 'secondary' : 'danger'}">${index + 1}</span>` :
            `<span class="badge bg-light text-dark">${index + 1}</span>`
          
          return `
            <tr>
              <td class="text-center">${rankBadge}</td>
              <td><strong>Spieler ${player.spieler}</strong></td>
              <td class="text-end"><span class="badge bg-primary">${player.turnierpunkte}</span></td>
              <td class="text-end">${player.partiepunkte}</td>
              <td class="text-center">${player.partien}</td>
            </tr>
          `
        }).join('')

        // Update statistics
        const uniquePlayers = new Set()
        const uniqueTables = new Set()
        tournamentData.parties.forEach(partie => {
          uniqueTables.add(partie.tisch)
          partie.results.forEach(r => uniquePlayers.add(r.spieler))
        })

        document.getElementById('activePlayers').textContent = uniquePlayers.size
        document.getElementById('activeTables').textContent = uniqueTables.size
        document.getElementById('totalGames').textContent = tournamentData.parties.length
      }

      // Display completed games
      function displayParties() {
        const tournamentData = loadTournamentData()
        const container = document.getElementById('partiesContainer')
        const countBadge = document.getElementById('partieCount')

        countBadge.textContent = `${tournamentData.parties.length} ${tournamentData.parties.length === 1 ? 'Partie' : 'Partien'}`

        if (tournamentData.parties.length === 0) {
          container.innerHTML = `
            <div class="text-center text-muted py-5">
              <i class="bi-inbox" style="font-size: 3rem;"></i>
              <p class="mt-3">Noch keine abgeschlossenen Partien</p>
              <a href="partie_erstellen.html" class="btn btn-primary mt-2">
                <i class="bi-plus-circle"></i> Erste Partie erstellen
              </a>
            </div>
          `
          return
        }

        container.innerHTML = tournamentData.parties.map((partie, index) => {
          const timestamp = new Date(partie.timestamp).toLocaleString('de-DE')
          return `
            <div class="card mb-3">
              <div class="card-header d-flex justify-content-between align-items-center">
                <span><strong>Tisch ${partie.tisch}</strong> - ${timestamp}</span>
                <button class="btn btn-sm btn-outline-danger" onclick="deletePartie(${index})">
                  <i class="bi-trash"></i>
                </button>
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-sm">
                    <thead>
                      <tr>
                        <th>Rang</th>
                        <th>Spieler</th>
                        <th class="text-end">Partiepunkte</th>
                        <th class="text-end">Turnierpunkte</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${partie.results.map((result, rank) => `
                        <tr>
                          <td>${rank + 1}.</td>
                          <td>Spieler ${result.spieler}</td>
                          <td class="text-end">${result.partiepunkte}</td>
                          <td class="text-end"><span class="badge bg-primary">${result.turnierpunkte}</span></td>
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          `
        }).join('')
      }

      window.deletePartie = function(index) {
        if (!confirm('Möchtest du diese Partie wirklich löschen?')) {
          return
        }
        const tournamentData = loadTournamentData()
        tournamentData.parties.splice(index, 1)
        saveTournamentData(tournamentData)
        refreshStandings()
      }

      window.refreshStandings = function() {
        displayStandings()
        displayParties()
      }

      // Initialize on load
      refreshStandings()
    </script>
  </body>
</html>
